<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Utility Consumption Dashboard</title>

  <!-- Load Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'ui-sans-serif', 'system-ui'],
          },
        },
      },
    };
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10 font-sans">

  <h1 class="text-4xl font-extrabold mb-8 text-gray-900 select-none">üìä Utility Consumption Dashboard</h1>

  <!-- Top Controls -->
  <div class="mb-6 flex flex-wrap gap-4 justify-center items-center">
    <button onclick="toggleCoil()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow">
      üîÑ Toggle Coil
    </button>
    <p class="text-gray-700">Current Coil: <span id="coilStatus" class="font-bold text-lg">--</span></p>
  </div>

  <!-- Threshold Controls -->
  <div class="mb-6 flex flex-wrap gap-4 justify-center">
    <label class="text-sm">
      Steam Threshold: <input type="number" id="steamThreshold" value="3000" class="border px-2 py-1 rounded" />
    </label>
    <label class="text-sm">
      Energy Threshold: <input type="number" id="energyThreshold" value="1500" class="border px-2 py-1 rounded" />
    </label>
    <label class="text-sm">
      Water Threshold: <input type="number" id="waterThreshold" value="500" class="border px-2 py-1 rounded" />
    </label>
    
  </div>
  
  <!-- Export Buttons -->
  <div class="flex gap-4 mb-4">
    <button onclick="exportCSV()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Export CSV</button>
    <button onclick="exportExcel()" class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded">Export Excel</button>
    <button onclick="exportPDF()" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded">Export PDF</button>
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 max-w-6xl w-full px-4 mb-4">
    <div class="bg-blue-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Steam (kg/h)</h2>
      <p id="steamVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-green-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Energy (kWh)</h2>
      <p id="energyVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-purple-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Water (m¬≥)</h2>
      <p id="waterVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-gray-800 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">‚è±Ô∏è Timestamp</h2>
      <p id="timeVal" class="text-xl font-mono tracking-wide">--</p>
    </div>
  </div>

  <!-- Table -->
  <div class="max-w-6xl w-full bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-y-auto max-h-96">
      <table class="min-w-full table-fixed border-collapse border border-gray-300">
        <thead class="bg-gray-800 text-white sticky top-0 z-10">
          <tr>
            <th class="py-3 px-6 text-left w-1/4">Steam (kg/h)</th>
            <th class="py-3 px-6 text-left w-1/4">Energy (kWh)</th>
            <th class="py-3 px-6 text-left w-1/4">Water (m¬≥)</th>
            <th class="py-3 px-6 text-left w-1/4">Timestamp</th>
          </tr>
        </thead>
        <tbody id="dataTable" class="bg-gray-50"></tbody>
      </table>
    </div>
  </div>

  <script>
    let lastTimestamp = null;
    let last30Data = [];

    function formatTimestamp(ts) {
      const dt = new Date(ts);
      if (isNaN(dt)) return ts;
      return `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}:${dt.getSeconds().toString().padStart(2, '0')}`;
    }

    function updateData(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return;

      const steamKey = Object.keys(rows[0]).find(k => /steam/i.test(k));
      const energyKey = Object.keys(rows[0]).find(k => /energy/i.test(k));
      const waterKey = Object.keys(rows[0]).find(k => /water/i.test(k));
      const timeKey = Object.keys(rows[0]).find(k => /(timestamp|date)/i.test(k));

      const latestRows = rows.slice(-30).reverse();
      last30Data = latestRows.map(row => ({
        Steam: row[steamKey],
        Energy: row[energyKey],
        Water: row[waterKey],
      }));

      const newest = rows[rows.length - 1];
      if (newest[timeKey] === lastTimestamp) return;
      lastTimestamp = newest[timeKey];

      document.getElementById('steamVal').textContent = newest[steamKey] ?? '--';
      document.getElementById('energyVal').textContent = newest[energyKey] ?? '--';
      document.getElementById('waterVal').textContent = newest[waterKey] ?? '--';
      document.getElementById('timeVal').textContent = formatTimestamp(newest[timeKey]);

      const steamThreshold = parseFloat(document.getElementById("steamThreshold")?.value || 3000);
      const energyThreshold = parseFloat(document.getElementById("energyThreshold")?.value || 1500);
      const waterThreshold = parseFloat(document.getElementById("waterThreshold")?.value || 500);

      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = latestRows.slice(0, 15).map(row => {
        const steam = parseFloat(row[steamKey]);
        const energy = parseFloat(row[energyKey]);
        const water = parseFloat(row[waterKey]);

        const steamClass = steam > steamThreshold ? "bg-red-100 text-red-600 font-semibold" : "";
        const energyClass = energy > energyThreshold ? "bg-yellow-100 text-yellow-700 font-semibold" : "";
        const waterClass = water > waterThreshold ? "bg-green-100 text-green-700 font-semibold" : "";

        return `
          <tr class="hover:bg-gray-200 transition-colors duration-150">
            <td class="border-b border-gray-300 py-2 px-4 ${steamClass}">${row[steamKey]}</td>
            <td class="border-b border-gray-300 py-2 px-4 ${energyClass}">${row[energyKey]}</td>
            <td class="border-b border-gray-300 py-2 px-4 ${waterClass}">${row[waterKey]}</td>
            <td class="border-b border-gray-300 py-2 px-4">${formatTimestamp(row[timeKey])}</td>
          </tr>
        `;
      }).join('');
    }

    function updateCoil(data) {
      const coilText = data?.coil == 1 ? "ON" : "OFF";
      document.getElementById("coilStatus").textContent = coilText;
    }

    function toggleCoil() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?toggleCoil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadCoilStatus() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?coil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadData() {
      const oldScript = document.getElementById('jsonpScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'jsonpScript';
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?callback=updateData&t=' + Date.now();
      document.body.appendChild(script);
    }

    function exportCSV() {
      let csv = "Steam,Energy,Water\n";
      last30Data.forEach(row => {
        csv += `${row.Steam},${row.Energy},${row.Water}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "utility_data.csv";
      link.click();
    }

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(last30Data);
      XLSX.utils.book_append_sheet(wb, ws, "Utility Data");
      XLSX.writeFile(wb, "utility_data.xlsx");
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Steam", "Energy", "Water"]];
      const rows = last30Data.map(row => [row.Steam, row.Energy, row.Water]);
      doc.autoTable({ head: headers, body: rows });
      doc.save("utility_data.pdf");
    }

    loadData();
    loadCoilStatus();
    setInterval(loadData, 3000);
    setInterval(loadCoilStatus, 5000);
  </script>
</body>
</html>
