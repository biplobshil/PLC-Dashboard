<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Utility Consumption Dashboard</title>

  <!-- Load Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'ui-sans-serif', 'system-ui'],
          },
        },
      },
    };
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10 font-sans">

  <h1 class="text-4xl font-extrabold mb-8 text-gray-900 select-none">ğŸ“Š Utility Consumption Dashboard</h1>

  <!-- Top Controls -->
  <div class="mb-6 flex flex-col items-center">
    <div class="flex gap-4 mb-4">
      <button onclick="toggleCoil()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow">ğŸ”„ Toggle Coil</button>
      <button onclick="exportCSV()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">ğŸ“¥ CSV</button>
      <button onclick="exportExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">ğŸ“Š Excel</button>
      <button onclick="exportPDF()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">ğŸ“„ PDF</button>
    </div>
    <p class="text-gray-700 text-center">Current Coil: <span id="coilStatus" class="font-bold text-lg">--</span></p>
  </div>

  <!-- Threshold Controls -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 max-w-4xl w-full px-4">
    <input id="thresholdSteam" type="number" placeholder="Steam Threshold" class="border p-2 rounded w-full" />
    <input id="thresholdEnergy" type="number" placeholder="Energy Threshold" class="border p-2 rounded w-full" />
    <input id="thresholdWater" type="number" placeholder="Water Threshold" class="border p-2 rounded w-full" />
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 max-w-6xl w-full px-4 mb-4">
    <div class="bg-blue-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Steam (kg/h)</h2>
      <p id="steamVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-green-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Energy (kWh)</h2>
      <p id="energyVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-purple-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Water (mÂ³)</h2>
      <p id="waterVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-gray-800 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">â±ï¸ Timestamp</h2>
      <p id="timeVal" class="text-xl font-mono tracking-wide">--</p>
    </div>
  </div>

  <!-- Table -->
  <div class="max-w-6xl w-full bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-y-auto max-h-96">
      <table class="min-w-full table-fixed border-collapse border border-gray-300">
        <thead class="bg-gray-800 text-white sticky top-0 z-10">
          <tr>
            <th class="py-3 px-6 text-left w-1/4">Steam (kg/h)</th>
            <th class="py-3 px-6 text-left w-1/4">Energy (kWh)</th>
            <th class="py-3 px-6 text-left w-1/4">Water (mÂ³)</th>
            <th class="py-3 px-6 text-left w-1/4">Timestamp</th>
          </tr>
        </thead>
        <tbody id="dataTable" class="bg-gray-50"></tbody>
      </table>
    </div>
  </div>

  <script>
    let lastTimestamp = null;
    let latestRowsCache = [];

    function formatTimestamp(ts) {
      const dt = new Date(ts);
      if (isNaN(dt)) return ts;
      return `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}:${dt.getSeconds().toString().padStart(2, '0')}`;
    }

    function updateData(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return;

      const steamKey = Object.keys(rows[0]).find(k => /steam/i.test(k)) || Object.keys(rows[0])[0];
      const energyKey = Object.keys(rows[0]).find(k => /energy/i.test(k)) || Object.keys(rows[0])[1];
      const waterKey = Object.keys(rows[0]).find(k => /water/i.test(k)) || Object.keys(rows[0])[2];
      const timeKey = Object.keys(rows[0]).find(k => /(timestamp|date)/i.test(k)) || Object.keys(rows[0])[3];

      const latestRows = rows.slice(-30).reverse();
      latestRowsCache = latestRows;

      const newest = rows[rows.length - 1];
      if (newest[timeKey] === lastTimestamp) return;
      lastTimestamp = newest[timeKey];

      document.getElementById('steamVal').textContent = newest[steamKey] ?? '--';
      document.getElementById('energyVal').textContent = newest[energyKey] ?? '--';
      document.getElementById('waterVal').textContent = newest[waterKey] ?? '--';
      document.getElementById('timeVal').textContent = formatTimestamp(newest[timeKey]);

      const steamThreshold = parseFloat(document.getElementById("thresholdSteam").value);
      const energyThreshold = parseFloat(document.getElementById("thresholdEnergy").value);
      const waterThreshold = parseFloat(document.getElementById("thresholdWater").value);

      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = latestRows.map(row => {
        const steamVal = row[steamKey];
        const energyVal = row[energyKey];
        const waterVal = row[waterKey];
        return `
          <tr class="hover:bg-gray-200 transition-colors duration-150">
            <td class="border-b border-gray-300 py-2 px-4 ${steamThreshold && steamVal > steamThreshold ? 'bg-red-200 font-bold' : ''}">${steamVal}</td>
            <td class="border-b border-gray-300 py-2 px-4 ${energyThreshold && energyVal > energyThreshold ? 'bg-yellow-200 font-bold' : ''}">${energyVal}</td>
            <td class="border-b border-gray-300 py-2 px-4 ${waterThreshold && waterVal > waterThreshold ? 'bg-green-200 font-bold' : ''}">${waterVal}</td>
            <td class="border-b border-gray-300 py-2 px-4">${formatTimestamp(row[timeKey])}</td>
          </tr>
        `;
      }).join('');
    }

    function updateCoil(data) {
      const coilText = data?.coil == 1 ? "ON" : "OFF";
      document.getElementById("coilStatus").textContent = coilText;
    }

    function toggleCoil() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?toggleCoil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadCoilStatus() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?coil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadData() {
      const oldScript = document.getElementById('jsonpScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'jsonpScript';
      script.src = 'https://script.google.com/macros/s/AKfycby0tirmzXpcyEuNVa9itlU9ibt2mMBpmd2P_8zLf_U/exec?callback=updateData&t=' + Date.now();
      document.body.appendChild(script);
    }

    function exportCSV() {
      const csv = latestRowsCache.map(row => Object.values(row).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "utility_data.csv";
      a.click();
    }

    function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(latestRowsCache);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      XLSX.writeFile(wb, "utility_data.xlsx");
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = Object.keys(latestRowsCache[0]);
      const rows = latestRowsCache.map(row => headers.map(h => row[h]));
      doc.autoTable({ head: [headers], body: rows });
      doc.save("utility_data.pdf");
    }

    loadData();
    loadCoilStatus();
    setInterval(loadData, 3000);
    setInterval(loadCoilStatus, 5000);
  </script>
</body>
</html>
