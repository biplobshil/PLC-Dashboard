<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Utility Consumption Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">ðŸ“Š Utility Dashboard</h1>

    <!-- Date Range Picker -->
    <div class="flex gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">From:</label>
        <input id="startDate" type="datetime-local" class="border rounded px-2 py-1">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">To:</label>
        <input id="endDate" type="datetime-local" class="border rounded px-2 py-1">
      </div>
    </div>

    <!-- Export Buttons -->
    <div class="flex gap-4 mb-4">
      <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Export CSV</button>
      <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Export Excel</button>
      <button onclick="exportPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Export PDF</button>
    </div>

    <!-- Paginated Table -->
    <div id="tableContainer" class="overflow-x-auto bg-white rounded shadow p-4"></div>
  </div>

  <script>
    let last30Data = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    const logoImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...'; // <-- insert your base64 logo here

    function parseCustomDate(str) {
      return new Date(str);
    }

    function filterDataByDateRange() {
      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);
      return last30Data.filter(row => {
        const rowDate = parseCustomDate(row.Timestamp);
        return rowDate >= start && rowDate <= end;
      }).sort((a, b) => parseCustomDate(a.Timestamp) - parseCustomDate(b.Timestamp));
    }

    function renderTable() {
      const filtered = filterDataByDateRange();
      const tableContainer = document.getElementById("tableContainer");
      const startIdx = (currentPage - 1) * rowsPerPage;
      const pageData = filtered.slice(startIdx, startIdx + rowsPerPage);

      let html = `<table class="min-w-full text-sm text-left">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2">Steam (kg/h)</th>
            <th class="p-2">Energy (kWh)</th>
            <th class="p-2">Water (mÂ³)</th>
            <th class="p-2">Timestamp</th>
          </tr>
        </thead>
        <tbody>`;

      pageData.forEach(row => {
        html += `<tr class="border-t">
          <td class="p-2">${row.Steam}</td>
          <td class="p-2">${row.Energy}</td>
          <td class="p-2">${row.Water}</td>
          <td class="p-2">${row.Timestamp}</td>
        </tr>`;
      });

      html += `</tbody></table><div class="mt-4 flex justify-center gap-2">`;

      const totalPages = Math.ceil(filtered.length / rowsPerPage);
      for (let i = 1; i <= totalPages; i++) {
        html += `<button onclick="goToPage(${i})" class="px-3 py-1 rounded ${i === currentPage ? 'bg-gray-700 text-white' : 'bg-gray-300' }">${i}</button>`;
      }
      html += `</div>`;
      tableContainer.innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    function exportCSV() {
      const filtered = filterDataByDateRange();
      let csv = "Steam,Energy,Water,Timestamp\n";
      filtered.forEach(row => {
        csv += `${row.Steam},${row.Energy},${row.Water},${row.Timestamp}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "utility_data.csv";
      link.click();
    }

    function exportExcel() {
      const filtered = filterDataByDateRange();
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(filtered);
      XLSX.utils.book_append_sheet(wb, ws, "Utility Data");
      XLSX.writeFile(wb, "utility_data.xlsx");
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add logo
      doc.addImage(logoImg, 'PNG', 10, 8, 30, 10);
      doc.setFontSize(14);
      doc.text("Utility Consumption Report", 50, 15);

      const headers = [["Steam", "Energy", "Water", "Timestamp"]];
      const rows = filterDataByDateRange().map(r => [r.Steam, r.Energy, r.Water, r.Timestamp]);
      doc.autoTable({ head: headers, body: rows, startY: 25 });
      doc.save("utility_data.pdf");
    }

    function loadDummyData() {
      const now = new Date();
      const past = new Date(now.getTime() - 48 * 3600 * 1000);
      for (let i = 0; i < 50; i++) {
        const time = new Date(past.getTime() + i * 3600 * 1000);
        last30Data.push({
          Steam: (Math.random() * 500).toFixed(2),
          Energy: (Math.random() * 100).toFixed(2),
          Water: (Math.random() * 150).toFixed(2),
          Timestamp: time.toLocaleString()
        });
      }
    }

    function setDefaultDateRange() {
      const now = new Date();
      const prior = new Date(now.getTime() - 24 * 3600 * 1000);
      document.getElementById("endDate").value = now.toISOString().slice(0, 16);
      document.getElementById("startDate").value = prior.toISOString().slice(0, 16);
    }

    loadDummyData();
    setDefaultDateRange();
    renderTable();

    document.getElementById("startDate").addEventListener("change", renderTable);
    document.getElementById("endDate").addEventListener("change", renderTable);
  </script>
</body>
</html>
