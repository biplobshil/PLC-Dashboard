<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Utility Consumption Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'ui-sans-serif', 'system-ui'],
          },
        },
      },
    };
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10 font-sans">

  <h1 class="text-4xl font-extrabold mb-8 text-gray-900 select-none">üìä Utility Consumption Dashboard</h1>

  <div class="mb-6 flex flex-wrap gap-4 justify-center items-center">
    <button onclick="toggleCoil()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow">
      ‚öôÔ∏è Chiller Control
    </button>
    <p class="text-gray-700 flex items-center gap-2">
      Status:
      <span id="coilIcon" class="w-4 h-4 rounded-full bg-gray-400 inline-block"></span>
      <span id="coilStatus" class="font-bold text-lg">--</span>
    </p>
  </div>

  <!-- Export Buttons -->
  <div class="flex gap-4 mb-6">
    <button onclick="exportCSV()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Export CSV</button>
    <button onclick="exportExcel()" class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded">Export Excel</button>
    <button onclick="exportPDF()" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded">Export PDF</button>
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 max-w-6xl w-full px-4 mb-4">
    <div class="bg-blue-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Steam (kg/h)</h2>
      <p id="steamVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-green-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Energy (kWh)</h2>
      <p id="energyVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-purple-600 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">Water (m¬≥)</h2>
      <p id="waterVal" class="text-4xl font-bold tracking-wide">--</p>
    </div>
    <div class="bg-gray-800 text-white rounded-xl shadow-md p-6 text-center">
      <h2 class="text-lg font-semibold mb-2">‚è±Ô∏è Timestamp</h2>
      <p id="timeVal" class="text-xl font-mono tracking-wide">--</p>
    </div>
  </div>

  <!-- Table -->
  <div class="max-w-6xl w-full bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-y-auto max-h-96">
      <table class="min-w-full table-fixed border-collapse border border-gray-300">
        <thead class="bg-gray-800 text-white sticky top-0 z-10">
          <tr>
            <th class="py-3 px-6 text-left w-1/4">Steam (kg/h)</th>
            <th class="py-3 px-6 text-left w-1/4">Energy (kWh)</th>
            <th class="py-3 px-6 text-left w-1/4">Water (m¬≥)</th>
            <th class="py-3 px-6 text-left w-1/4">Timestamp</th>
          </tr>
        </thead>
        <tbody id="dataTable" class="bg-gray-50"></tbody>
      </table>
    </div>
  </div>

  <script>
    let lastTimestamp = null;
    let last30Data = [];

    function formatTimestamp(ts) {
      const dt = new Date(ts);
      if (isNaN(dt)) return ts;
      return `${dt.getMonth() + 1}/${dt.getDate()}/${dt.getFullYear()} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}:${dt.getSeconds().toString().padStart(2, '0')}`;
    }

    function updateData(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return;

      const steamKey = Object.keys(rows[0]).find(k => /steam/i.test(k));
      const energyKey = Object.keys(rows[0]).find(k => /energy/i.test(k));
      const waterKey = Object.keys(rows[0]).find(k => /water/i.test(k));
      const timeKey = Object.keys(rows[0]).find(k => /(timestamp|date)/i.test(k));

      const latestRows = rows.slice(-30).reverse();
      last30Data = latestRows.map(row => ({
        Steam: row[steamKey],
        Energy: row[energyKey],
        Water: row[waterKey],
        Timestamp: formatTimestamp(row[timeKey])
      }));

      const newest = rows[rows.length - 1];
      if (newest[timeKey] === lastTimestamp) return;
      lastTimestamp = newest[timeKey];

      document.getElementById('steamVal').textContent = newest[steamKey] ?? '--';
      document.getElementById('energyVal').textContent = newest[energyKey] ?? '--';
      document.getElementById('waterVal').textContent = newest[waterKey] ?? '--';
      document.getElementById('timeVal').textContent = formatTimestamp(newest[timeKey]);

      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = latestRows.slice(0, 15).map(row => `
        <tr class="hover:bg-gray-200 transition-colors duration-150">
          <td class="border-b border-gray-300 py-2 px-4">${row[steamKey]}</td>
          <td class="border-b border-gray-300 py-2 px-4">${row[energyKey]}</td>
          <td class="border-b border-gray-300 py-2 px-4">${row[waterKey]}</td>
          <td class="border-b border-gray-300 py-2 px-4">${formatTimestamp(row[timeKey])}</td>
        </tr>
      `).join('');
    }

    function updateCoil(data) {
      const coilOn = data?.coil == 1;
      document.getElementById("coilStatus").textContent = coilOn ? "ON" : "OFF";
      document.getElementById("coilIcon").className = `w-4 h-4 rounded-full inline-block ${coilOn ? 'bg-green-500' : 'bg-red-500'}`;
    }

    function toggleCoil() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec?toggleCoil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadCoilStatus() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec?coil=true&callback=updateCoil&t=' + Date.now();
      document.body.appendChild(script);
    }

    function loadData() {
      const oldScript = document.getElementById('jsonpScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.id = 'jsonpScript';
      script.src = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec?callback=updateData&t=' + Date.now();
      document.body.appendChild(script);
    }

    function exportCSV() {
      let csv = "Steam (kg/h),Energy (kWh),Water (m¬≥),Timestamp\n";
      last30Data.forEach(row => {
        csv += `${row.Steam},${row.Energy},${row.Water},${row.Timestamp}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "utility_data.csv";
      link.click();
    }

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const wsData = [["Steam (kg/h)", "Energy (kWh)", "Water (m¬≥)", "Timestamp"]];
      last30Data.forEach(row => {
        wsData.push([row.Steam, row.Energy, row.Water, row.Timestamp]);
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Utility Data");
      XLSX.writeFile(wb, "utility_data.xlsx");
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const headers = [["Steam (kg/h)", "Energy (kWh)", "Water (m¬≥)", "Timestamp"]];
      const rows = last30Data.map(row => [row.Steam, row.Energy, row.Water, row.Timestamp]);

      doc.setFontSize(14);
      doc.text("Utility Consumption Report (Last 30 Records)", 14, 15);

      doc.autoTable({
        head: headers,
        body: rows,
        startY: 20,
        styles: {
          fontSize: 10,
          cellPadding: 3,
        },
        headStyles: {
          fillColor: [41, 128, 185],
          textColor: 255,
          fontStyle: 'bold'
        },
      });

      const pdfBlob = doc.output('blob');
      const pdfUrl = URL.createObjectURL(pdfBlob);
      window.open(pdfUrl, '_blank');
    }

    loadData();
    loadCoilStatus();
    setInterval(loadData, 3000);
    setInterval(loadCoilStatus, 5000);
  </script>
</body>
</html>
